---
title: "CRK cont SR - QAQC & plot"
author: "Moeka"
date: '2024-02-19'
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r insatall packages}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

library(ggplot2)
library(dplyr)                  
library(tidyr)
library(googlesheets4)
library(lubridate)
library(PerformanceAnalytics)
library(ggpmisc)
library(Hmisc)
library(scales)
library(hms)

# doesn't work anymore
#library(RespChamberProc)
## How to install RespChamberProc? -> Go to https://freesoft.dev/program/97026756.
```

```{r reading raw data - old}
#knitr::opts_chunk$set(eval = FALSE)
#raw <- read81xVar("G:/My Drive/research/DC_auto/DC_042922_auto.81x") # will take some time

# raw$iChunk <- as.character(raw$iChunk)

#remove incomplete observation
#df <- raw[raw$iChunk != 1,]
```
Note: 
- 2022-08-16 ~ 2022-08-23: shallow/deep labels were not recorded. Have to be manually added. Port#5 = shallow; Port#14 = deep.
```{r read df}

setwd("G:/Shared drives/Project_Crockett/Field work/Continuous SR measurement/Processed data")

# 2022-2024
# function - read and rbind the datasets
importBind <- function(x){
  temp <- list.files(pattern = paste0("*",x))
  bind <- do.call("rbind", lapply(temp, read.csv, header = T))
  return(bind)
}

# read SoilFluxPro outputs in 2022-2024
SR_cont_raw <- importBind("CRK_cont_SFP_qaqc")


str(SR_cont_raw)
unique(SR_cont_raw$Label)

# function to clean up the variables
clean_cont <- function(df){  
  df %>%
  mutate(Datetime_CST = as.POSIXct(Date_IV, format = "%m/%d/%Y %H:%M", tz = "Etc/GMT+6"),
         Flux = ifelse(grepl("Exp", CrvFitStatus), Exp_Flux, Lin_Flux),
         CV = ifelse(grepl("Exp", CrvFitStatus), Exp_FluxCV, Lin_FluxCV),
         R2 = ifelse(grepl("Exp", CrvFitStatus), as.numeric(Exp_R2), as.numeric(Lin_R2))) %>%
  filter(!is.na(Datetime_CST)) %>% 
  distinct()
  }

# clean up variables
SR_cont <- clean_cont(SR_cont_raw)

# clean up Label
SR_cont_v1 <- 
  SR_cont %>%
  mutate(Collar = case_when(Label == "shallow" ~ "sh1",
                            Label == "shallow2" ~ "sh2",
                            Label == "shallow3" ~ "sh3",
                            Label == "long" ~ "deep",
                            TRUE ~ Label)) %>%
  mutate(Collar = case_when(Collar == "" & Port. == "5" ~ "sh1",
                            Collar == "" & Port. == "14" ~ "deep",
                            TRUE ~ Collar))

# should be only 4 types
unique(SR_cont_v1$Collar)
```

"Obs.": doesn't matter much "Port.": Multiplexer port number (0 if not
using a multiplexer) "Date_IV": date type default is "M/DD/YYYY HH:SS"
"Offset": Offset (cm) used in volume calculation.

"CrvFitStatus": Curve fit solution. "Exp" means the exponential fit was
better than the linear fit (Exp_SSN \< Lin\_ SSN). "Lin" means the
linear fit was still better after the maximum number of iterations, and
the nonlinear coefficients have therefore been derived from linear fit.

"Exp_Flux": Flux computed from Exponential Fit. "Exp_FluxCV":
Coefficient of variance (%) of Exp Flux "Exp_R2": Correlation
coefficient for Exponential Fit. "Exp_Iter": Number of iterations used
in the Exponential Fit. "Lin_Flux": Flux computed from Linear Fit.
"Lin_FluxCV": Coefficient of variable (%) of Lin Flux "Lin_R2":
Correlation coefficient for the Linear Fit. "Observation.Length": The
original observation length. "V1_IV": Initial values of the voltage
channel\
"V1_Mean": Initial values of the voltage channel = Flow signals
"Cdry_Mean": Chamber CO2 concentration (Î¼mol/mol), corrected for water
vapor dilution "Tcham_Mean": Air temperature (C) inside the soil chamber
during an active measurement (if no measurement is active, displays
Multiplexer case temperature)

"Pressure_Mean": Atmospheric pressure in the optical bench (kPa)
"H2O_Mean": Chamber water vapor concentration (mmol/mol) "Label": User
entered at time of data collection. "Vmux": Volume of the multiplexer
(if used) (cm3)

```{r raw data plot}

ggplot(SR_cont_v1) + 
  geom_point(aes(Datetime_CST, Flux, col = as.character(Collar))) + 
  theme_bw()

```

```{r qaqc distribution}
# R2
ggplot(SR_cont_v1, aes(x = R2, col = Collar)) + 
  geom_freqpoly(bins=100, size = .8, alpha = .5) + xlim(.96,1) + theme_bw()

# CV
ggplot(SR_cont_v1, aes(x = CV, col = Collar)) + 
  geom_freqpoly(bins=100, size = .8, alpha = .5) + xlim(.8,2) + theme_bw()

# Cdry_Mean
ggplot(SR_cont_v1, aes(x = Cdry_Mean, col = Collar)) + 
  geom_freqpoly(bins=100, size = .8, alpha = .5) + xlim(350,1000) + theme_bw()

# V1_Mean
ggplot(SR_cont_v1, aes(x = V1_Mean, col = Collar)) + 
  geom_freqpoly(bins=100, size = .8, alpha = .5) + theme_bw()


# V1 vs R2
ggplot(SR_cont_v1, aes(x = V1_Mean, y = CV, col = as.character(Collar))) + 
  geom_point(size = .8, alpha = .5) + theme_bw() + ylim(.8,10)

# boxplot after applying 3 variables
SR_cont_v1 %>% filter(R2 > .985 & CV < 1.25 & V1_Mean > 2) %>%
ggplot() + geom_boxplot(aes(as.character(Collar), Flux)) + theme_bw()


# cont %>% filter(Label == "shallow") %>% summarize(quantile(Cdry_Mean, .75) + 1.5*IQR(Cdry_Mean))
# the upper limit was 755.34

# raw data
# pairs(cont[,c(15,16,18,23:25)],
#       lower.panel = NULL, 
#       col = factor(cont$Label),
#       cex.labels=3)

# cont %>% 
#   filter(R2 > 0.9 & CV < 10) %>%
#   select(c(15,16,18,23:25)) %>%
#   pairs(lower.panel = NULL, 
#       col = factor(cont$Label),
#       cex.labels=3)
```

## QAQC 
# Related to Flux
- R2 > 0.975
- CV < 1.9
- negative Flux

# Related to instrument
- V1_Mean > 2


Note: 
- Negative or very low flux can be captured by CV and V1 but not R2 as they can have clean lines
- V1 values depend on chambers but all of them should be over 2 when running properly
- Deep collar still observed very large fluxes which did not appear in other shallow collars even after QAQC with 3 variables above.
- Are they likely due to insects or micro fauna? Can I just remove them?


```{r qaqc data, fig.width=15,fig.height=8}
cont_qaqc <- 
  SR_cont_v1 %>% 
  filter(CV < 1.9 & R2 > 0.975 & V1_Mean > 2 & Flux > 0) %>% 
  arrange(Datetime_CST)

# all the data after QAQCed
ggplot(cont_qaqc) + 
  geom_point(aes(Datetime_CST, Flux, col = Collar), alpha = .5) + 
  theme_bw() + 
  ggtitle("All data available since 2022", subtitle = "QAQC: R2 > 0.975, CV < 1.9, V1 > 2") +
  scale_x_datetime(date_breaks = "6 months", date_labels = "%b-%Y") +
  theme(axis.title.x = element_blank(), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 15), legend.text = element_text(size = 15),
        plot.title = element_text(size = 15, face = "bold"))



#write.csv(cont_qaqc, "G:/Shared drives/Project_Crockett/Field work/Continuous SR measurement/Processed data/cont_qaqc.csv", row.names = FALSE)
```

Refer to field log for cont chambers - deep collar installation 
- 1. 2022-04-29 
- 2. 2023-04-11 
- 3. 2023-10-29

Term_1: 2022-05-22 and 2022-06-12: also available a few days around
2022-06-26

```{r when the pure Rh is available}
# data availability for 2022
cont_qaqc %>% 
  filter(format(as.Date(Datetime_CST),"%Y") == "2022") %>%
  ggplot() + 
  geom_point(aes(Datetime_CST, Flux, col = Collar), alpha = .5) + 
  theme_bw() + labs(color = "Collar type") + 
  ggtitle("Data avilable in 2022", subtitle = "Deep collar installed on Apr 29th") + 
  scale_x_datetime(date_breaks = "1 months", date_labels = "%b-%Y") +
  theme(axis.title.x = element_blank(), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 15), legend.text = element_text(size = 15),
        plot.title = element_text(size = 15, face = "bold"))



# deep available from 2022-05-22 11:25 am till 2022-06-09 15:25
cont_qaqc %>% 
  filter(Datetime_CST > "2022-05-22" & Datetime_CST < "2022-06-26") %>% 
  ggplot() + geom_point(aes(Datetime_CST, Flux, col = Collar)) + theme_bw() +
  ggtitle("1-2 months after deep collar installation", subtitle = "From 2022-05-22 to 2022-06-26")


cont_qaqc %>% 
  filter(Datetime_CST > "2022-11-22" & Datetime_CST < "2022-12-01") %>% 
  ggplot() + geom_point(aes(Datetime_CST, Flux, col = as.character(Label))) + theme_bw() + 
  ggtitle("7 months after deep collar installation", subtitle = "From 2022-11-23 to 2022-11-30")


# # data availability for 2023
cont_qaqc %>% 
  filter(format(as.Date(Datetime_CST),"%Y") == "2023") %>%
  ggplot() + 
  geom_point(aes(Datetime_CST, Flux, col = Collar), alpha = .5) + 
  theme_bw() +  labs(color = "Collar type") + 
  ggtitle("Data avilable in 2023", subtitle = "Deep collar installed on Apr 11th & Oct 29th") + 
  scale_x_datetime(date_breaks = "2 months", date_labels = "%b-%Y") +
  theme(axis.title.x = element_blank(), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 15), legend.text = element_text(size = 15),
        plot.title = element_text(size = 15, face = "bold"))
 

cont_qaqc %>% 
  filter(Datetime_CST < "2023-04-04" & Datetime_CST > "2023-03-10") %>% 
  ggplot() + geom_point(aes(Datetime_CST, Flux, col = as.character(Label))) + theme_bw() + 
  ggtitle("10-11 months after deep collar installation", subtitle = "From 2023-03-10 to 2023-04-04")


# REMOVE OUTLIERS >10
cont_qaqc %>% 
  filter(Datetime_CST > as.Date("2023-04-25") & Datetime_CST < as.Date("2023-06-08")) %>% 
  ggplot() + geom_point(aes(Datetime_CST, Flux, col = as.character(Label))) + theme_bw()+ 
  ggtitle("0-2 month after deep collar installation", subtitle = "From 2023-04-30 to 2023-06-08")

cont_qaqc %>% 
  filter(Datetime_CST > as.Date("2023-05-23") & Datetime_CST < as.Date("2023-06-08")) %>% 
  ggplot() + geom_point(aes(Datetime_CST, Flux, col = as.character(Label))) + theme_bw()+ 
  ggtitle("0-2 month after deep collar installation", subtitle = "From 2023-05-20 to 2023-06-08")


# looking wierd since end of august 2023
cont_qaqc %>% 
  filter(Datetime_CST < as.Date("2023-09-17") & Datetime_CST > as.Date("2023-08-10")) %>% 
  filter(Flux < 10) %>% # did not get removed by filters
  ggplot() + geom_point(aes(Datetime_CST, Flux, col = as.character(Label))) + theme_bw() + 
  ggtitle("4-5 month after deep collar installation", subtitle = "From 2023-08-10 to 2023-09-17")


cont_qaqc %>% 
  filter(Datetime_CST > as.Date("2024-01-24") & Datetime_CST < as.Date("2024-02-05")) %>%# filter(Label %in% c("sh2", "deep")) %>%
  ggplot() + geom_point(aes(Datetime_CST, Flux, col = as.character(Label)), alpha = .5) + theme_bw() + 
  ggtitle("3 months after deep collar installation", subtitle = "From 2024-01-24 to 2024-02-05")


```


```{r Fetching tower data}
#setwd("G:/Shared drives/Project_Crockett/Temp")
setwd("G:/My Drive/Research/Projects/DC_auto/Data/Biomet")

# read files: 22 & 23 are for Ameriflux and 24 for only biomet
biomet_22_raw <- read.csv("US-CRK_HH_202201010000_202301010000.csv")
biomet_23_raw <- read.csv("US-CRK_HH_202301010000_202401010000.csv")
biomet_24_raw <- read.csv("CRK_biomet_2024.csv")

# unit change function
biomet_unit <- 
  function(df){
      df %>%
      # WATCH OUT: ymd_hm set timezone as UTC as default
      # Use tzone = "Etc/GMT+6" instead of "America/Chicago"
      # the latter generates daylight saving time and NA as default and no way prevending from it
      mutate(TIMESTAMP_START = force_tz(ymd_hm(TIMESTAMP_START), tzone = "Etc/GMT+6"),
             TIMESTAMP_END = force_tz(ymd_hm(TIMESTAMP_END), tzone = "Etc/GMT+6")) %>%
      mutate(across(where(is.numeric), na_if, -9999)) # change -9999 to NA
  }

biomet_22 <- biomet_unit(biomet_22_raw)
biomet_23 <- biomet_unit(biomet_23_raw)

# function: aggregate to hourly 
biomet_hr <- function(df){
  df %>% 
    mutate(Datetime_hr_CST = floor_date(TIMESTAMP_START, unit = "hour")) %>%
    group_by(Datetime_hr_CST) %>%
    summarise(across(CO2_1_1_1:NEE_1_2_1, ~ mean(.x, na.rm = TRUE))) # aggregate to hourly
}

# applying the function
biomet_22_hr <- biomet_hr(biomet_22)
biomet_23_hr <- biomet_hr(biomet_23)


# just for biomet data - timestamp is different from Ameriflux standard
biomet_24 <- 
  biomet_24_raw[-1,] %>%
  mutate(Timestamp_1 = force_tz(ymd_hm(as.character(Timestamp_1)), tzone = "Etc/GMT+6")) %>%
  mutate(across(where(is.character), as.numeric)) 

# you can check where NA values were generated
which(is.na(biomet_24$Timestamp_1), arr.ind = T)

biomet_24_hr <- 
  biomet_24 %>%
  mutate(Datetime_hr_CST = floor_date(Timestamp_1, unit = "hour")) %>%
  group_by(Datetime_hr_CST) %>%
  summarise(across(Ta_1_1_1:SWC_1_2_1, ~ mean(.x, na.rm = TRUE))) %>% 
  # changing column names to fit Ameriflux standard
  rename(
    PPFD_IN_1_1_1 = PPFD_1_1_1,
    TS_1_1_1 = Ts_1_1_1,
    TS_1_2_1 = Ts_1_2_1,
    TS_2_1_1 = Ts_2_1_1,
    TS_2_2_1 = Ts_2_2_1,
    TS_2_3_1 = Ts_2_3_1
  )
  
# creating a biomet df from 2022-2024
biomet <- 
  rbind(biomet_22_hr, biomet_23_hr) %>%
  select(Datetime_hr_CST, PPFD_IN_1_1_1, TS_1_1_1, TS_1_2_1, TS_2_1_1, TS_2_2_1, TS_2_3_1, SWC_1_1_1) %>%
  rbind(biomet_24_hr %>% select(Datetime_hr_CST, PPFD_IN_1_1_1, TS_1_1_1, TS_1_2_1, TS_2_1_1, TS_2_2_1, TS_2_3_1, SWC_1_1_1)) %>%
  mutate(across(where(is.numeric), function(x) ifelse(is.nan(x), NA, x)))
```

```{r basic plot for tower data}

# PPFD_IN_1_1_1
ggplot(biomet) + 
  geom_point(aes(Datetime_hr_CST, PPFD_IN_1_1_1)) + 
  theme_bw() + 
  ggtitle("Data covarage - Above canopy PAR") + 
  ylab(expression("Density ("~mu~"mol Photon m"^2~"s"^-1~")")) + 
  scale_x_datetime(date_breaks = "6 months", date_labels = "%b-%Y") +
  theme(axis.title.x = element_blank(), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
        plot.title = element_text(size = 15, face = "bold"))

# TS_1
ggplot(biomet) + 
  geom_point(aes(Datetime_hr_CST, TS_1_1_1, col = "TS_1 5cm"), alpha = .05) +
  geom_point(aes(Datetime_hr_CST, TS_1_2_1, col = "TS_1 20cm"), alpha = .05) +
  theme_bw() + 
  ggtitle("Data covarage - soil temp at 5 & 20 cm depth") + 
  ylab("Soil temperature (\u00B0C)") +
  scale_color_manual("", values = c("#F8766D", "#00BFC4")) +
  scale_x_datetime(date_breaks = "6 months", date_labels = "%b-%Y") +
  theme(axis.title.x = element_blank(), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 15), legend.text = element_text(size = 15),
        plot.title = element_text(size = 15, face = "bold"))

# TS_2
# 2023 data until end of Sep 2023

ggplot(biomet) + 
  geom_point(aes(Datetime_hr_CST, TS_2_1_1, col = "TS_2 5 cm"), alpha = .05) +
  geom_point(aes(Datetime_hr_CST, TS_2_2_1, col = "TS_2 10 cm"), alpha = .05) +
  geom_point(aes(Datetime_hr_CST, TS_2_3_1, col = "TS_2 30 cm"), alpha = .05) +
  theme_bw() + 
  ggtitle("Data covarage - soil temp at 5, 10, 30  cm depth") + 
  ylab("Soil temperature (\u00B0C)") +
  scale_color_manual("", values = c("#F8766D", "#00BFC4", "#00BA38")) +
  scale_x_datetime(date_breaks = "6 months", date_labels = "%b-%Y") +
  theme(axis.title.x = element_blank(), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 15), legend.text = element_text(size = 15),
        plot.title = element_text(size = 15, face = "bold"))

# SWC_1
# 2023 data until end of Sep 2023
ggplot(biomet) + 
  geom_point(aes(Datetime_hr_CST, SWC_1_1_1)) + 
  theme_bw() + 
  ggtitle("Data covarage - Soil moisture") + 
  ylab("Soil moisture (%)") +
  scale_x_datetime(date_breaks = "6 months", date_labels = "%b-%Y") +
  theme(axis.title.x = element_blank(), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
        plot.title = element_text(size = 15, face = "bold"))

```

```{r sunrise & sunset}
# not using in the current version
setwd("G:/My Drive/Research/Projects/DC_auto/Data")
sun_22_raw <- read_excel("CRK_navy_2022.xlsx") 
sun_23_raw <- read_excel("CRK_navy_2023.xlsx")

name_to_num <- data.frame(
  month_num = c(1:12),
  name = unique(sun_22_raw$Month)
)

# clean navy dataset
sun_clean <- 
  function(df){
      df %>%
         left_join(name_to_num, by = c("Month" = "name")) %>%
         mutate(sunrise_hour = as.integer(substring(Sunrise, 1, 1)), 
                sunrise_min = as.integer(substring(Sunrise, 2,3)),
                sunset_hour = as.integer(substring(Sunset, 1, 2)), 
                sunset_min = as.integer(substring(Sunset, 3,4)),
                ) %>% 
         mutate(Date = make_date(Year, month_num, DoM),
                sunrise_timestamp = make_datetime(Year, month_num, DoM, sunrise_hour, sunrise_min),
                sunset_timestamp = make_datetime(Year, month_num, DoM, sunset_hour, sunset_min))
  }

# cleaned sunrise/sunset df
sun_22 <- sun_clean(sun_22_raw)
sun_23 <- sun_clean(sun_23_raw)
```

```{r canopy conductance}
setwd("G:/My Drive/Research/Projects/DC_auto/Data/canopy_conductance")

CRK_gs_raw <- read.csv("CRK_canopy_conductance.csv") 

CRK_gs<- 
  CRK_gs_raw %>% 
  mutate(Datetime_hr_CST = force_tz(as_datetime(Datetime_hr_CST), tzone = "Etc/GMT+6"))
```

```{r combining three dfs}

cont_qaqc_hr <- 
  cont_qaqc %>%
  mutate(Datetime_hr_CST = floor_date(Datetime_CST, unit = "hour")) %>% # round it down
  select(c(Datetime_hr_CST, Flux, Collar)) %>%
  pivot_wider(names_from = Collar,
              values_from = Flux,
              values_fn = ~ mean(.x, na.rm = TRUE)) %>% # when having duplicates
  rename(SR1 = sh1, SR2 = sh2, SR3 = sh3, Rh = deep) %>%
  mutate(Ra1 = SR1 - Rh, Ra2 = SR2-Rh, Ra3 = SR3-Rh)
  
# combine 3 dfs
SR_tower <- 
  left_join(biomet, cont_qaqc_hr, by = "Datetime_hr_CST") %>%
  left_join(CRK_gs,by = "Datetime_hr_CST")
  

# write csv
#write.csv(SR_tower, "G:/My Drive/Research/Projects/DC_auto/Data/CRK_SR_tower_combined.csv", row.names = F)



# SR_biomet <- function(SR_start, SR_end, df_sun, df_biomet){
#   cont_qaqc %>% 
#   filter(Datetime_CST > SR_start & Datetime_CST < SR_end) %>%
#   mutate(Datetime_30min_CST = floor_date(Datetime_CST, unit = "30minutes")) %>% # round it down
#   select(c(Datetime_30min_CST, Flux, Label)) %>%
#   pivot_wider(names_from = Label,
#               values_from = c(Flux)) %>%
#   na.omit() %>%
#   rename(SR = shallow, 
#          Rh = deep) %>%
#   mutate(Ra = SR - Rh,
#          Date_CST = as.Date(Datetime_30min_CST)
#          ) %>%
#   left_join(df_sun %>% select(c(Date, sunrise_timestamp, sunset_timestamp)), by = c("Date_CST" = "Date")) %>%
#   left_join(df_biomet, by = c("Datetime_30min_CST" = "TIMESTAMP_START")) %>%
#   mutate(day_night = ifelse(between(Datetime_30min_CST, sunrise_timestamp,sunset_timestamp) == TRUE,"day","night")) 
# }
# 
# 
# SR_biomet_hr <- function(df_SR, SR_start, SR_end, Ra_name, df_biomet){
#   df_SR %>%
#   filter(Datetime_CST > SR_start & Datetime_CST < SR_end) %>%
#   mutate(Datetime_hr_CST = floor_date(Datetime_CST, unit = "hour")) %>% # round it down
#   select(c(Datetime_hr_CST, Flux, Label)) %>%
#   pivot_wider(names_from = Label,
#               values_from = Flux,
#               values_fn = ~ mean(.x, na.rm = TRUE)) %>% # when having duplicates
#   rename(SR = {{Ra_name}}, 
#          Rh = deep) %>%
#   mutate(Ra = SR - Rh) %>%
#   left_join(df_biomet, by = "Datetime_hr_CST")
# }

```







```{r extract available Rh periods}
# one of the best period
SR_may22 <- SR_biomet("2022-05-22", "2022-06-10", sun_22, biomet_22)

# getting similar 
SR_nov22 <- SR_biomet("2022-11-22", "2022-12-01", sun_22, biomet_22)

# getting similar 
SR_mar23 <- SR_biomet("2023-03-10", "2023-04-04", sun_23, biomet_23)

# looking alright - removing outliers > 10
SR_may23 <- 
  SR_biomet("2023-04-30", "2023-06-08", sun_23, biomet_23) %>%
  filter(SR < 10 & Rh < 10) %>% arrange(Datetime_30min_CST)


# better half
SR_may23_2 <- 
  SR_biomet("2023-05-23", "2023-06-08", sun_23, biomet_23) %>%
  filter(SR < 10 & Rh < 10) %>% arrange(Datetime_30min_CST)


SR_feb24 <- 
  SR_biomet_hr(cont_qaqc_24 %>% filter(Label %in% c("deep", "sh1")), "2024-02-20", "2024-03-09", sh1, biomet_24_hr)
```


```{r Diurnal patterns}

# this can be later
cont_qaqc %>% 
  filter(Datetime_CST > "2022-05-22" & Datetime_CST < "2022-06-09") %>% 
  filter(Label == "shallow") %>%
  mutate(hour =  as_hms(ymd_hms(Datetime_CST))) %>% 
  ggplot() + geom_point(aes(hour, Flux, col = as.Date(Datetime_CST))) + 
  theme_bw() + ggtitle("Diurnal SR parttern", subtitle = "2022-05-22 ~ 2022-06-09 (M1-2)")


  cont_qaqc %>% 
  filter(Date > "2023-05-20" & Date < "2023-06-26") %>% 
  filter(Label == "shallow" & Flux < 10) %>%
  mutate(hour =  format(as.POSIXct(Date), format = "%H:%M:%S")) %>%
  ggplot() + geom_point(aes(hour, Flux))

  
  
  
cont_qaqc %>% 
    filter(Datetime_CST > "2022-04-01" & Datetime_CST < "2022-06-30") %>% 
    filter(Label == "shallow") %>%
    mutate(hour =  as_hms(ymd_hms(Datetime_CST))) %>% 
    ggplot() + geom_point(aes(hour, Flux, col = as.character(month(Datetime_CST))), alpha = .5) + 
    theme_bw() + ggtitle("Diurnal SR parttern", subtitle = "2022-04-01 ~ 2022-06-30")  




# Diurnal patterns for SR
cont_qaqc %>% 
    filter(format(as.Date(Datetime_CST),"%Y") == "2023") %>% 
    filter(Label == "shallow" & Flux < 15) %>%
    mutate(hour =  as_hms(ymd_hms(Datetime_CST))) %>% 
    ggplot(aes(hour, Flux, col = as.factor(month(Datetime_CST)))) + 
    geom_point(alpha = .3) + 
    geom_smooth(alpha = .3, se = F) + 
    theme_bw() + ggtitle("Diurnal SR parttern", subtitle = "2023") + 
    labs(color = "Month") + 
    ylab(expression("SR ("~mu~"mol m"^2~"s"^-1~")")) + xlab("Time of day") + 
    theme(axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 15), legend.text = element_text(size = 15),
        plot.title = element_text(size = 15, face = "bold"))

# Diurnal patterns for PAR
biomet_23 %>%
    mutate(hour = as_hms(ymd_hms(TIMESTAMP_START))) %>% 
    filter(!is.na(PPFD_IN_1_1_1) & !is.na(hour)) %>%
    ggplot(aes(hour, PPFD_IN_1_1_1, col = as.factor(month(TIMESTAMP_START)))) + 
    geom_point(alpha = .3) + 
    geom_smooth(alpha = .3, se = F) + 
    theme_bw() + ggtitle("Diurnal PAR parttern", subtitle = "2023") + 
    labs(color = "Month") + 
    ylab(expression("Density ("~mu~"mol Photon m"^2~"s"^-1~")")) + xlab("Time of day") + 
    theme(axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 15), legend.text = element_text(size = 15),
        plot.title = element_text(size = 15, face = "bold"))

# Diurnal patterns for TS_1_1_1
biomet_23 %>%
    mutate(hour =  as_hms(ymd_hms(TIMESTAMP_START))) %>% 
    filter(!is.na(TS_1_1_1) & !is.na(hour)) %>%
    ggplot(aes(hour, TS_1_1_1, col = as.factor(month(TIMESTAMP_START)))) + 
    geom_point(alpha = .3) + 
    geom_smooth(alpha = .3, se = F) + 
    theme_bw() + ggtitle("Diurnal Ts parttern at the depth of 5 cm ", subtitle = "2023") + 
    labs(color = "Month") +
    ylab("Soil temperature (\u00B0C)") + xlab("Time of day") + 
    theme(axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 15), legend.text = element_text(size = 15),
        plot.title = element_text(size = 15, face = "bold"))

# Diurnal patterns for SWC_1_1_1
biomet_23 %>%
    mutate(hour =  as_hms(ymd_hms(TIMESTAMP_START))) %>% 
    filter(!is.na(SWC_1_1_1) & !is.na(hour)) %>%
    ggplot(aes(hour, SWC_1_1_1, col = as.factor(month(TIMESTAMP_START)))) + 
    geom_point(alpha = .3) + 
    geom_smooth(alpha = .3, se = F) + 
    theme_bw() + ggtitle("Diurnal SWC parttern at the depth of 5 cm ", subtitle = "2023") + 
    labs(color = "Month") +
    ylab("Soil moisture (%)") + xlab("Time of day") + 
    theme(axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 15), legend.text = element_text(size = 15),
        plot.title = element_text(size = 15, face = "bold"))
  
 
```

```{r temporal diurnal patterns}
temporal_diurnal <- function(df, var1, var1_name, var2, var2_name, term){
    df %>%
    mutate(var1_norm = rescale({{var1}}),
           var2_norm = rescale({{var2}})) %>%
    ggplot(aes(x = Datetime_30min_CST)) +
    geom_line(aes(y = var1_norm, color = var1_name), size = 1.4, alpha = .5) + 
    geom_line(aes(y = var2_norm, color = var2_name), size = 1.4, alpha = .5) +
    scale_color_manual("", values = c("#F8766D", "#00BFC4")) +
    theme_bw() + ggtitle("Diurnal pattern", subtitle = term) + 
    theme(legend.position = "top") + ylab("Normalized") + 
    theme(axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 15),
          axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
          legend.title = element_text(size = 15), legend.text = element_text(size = 15),
          plot.title = element_text(size = 15, face = "bold"))
}


## may22
# Ra vs PAR
temporal_diurnal(SR_may22, Ra, "Ra", PPFD_IN_1_1_1, "PAR", "2022-05-22 ~ 2022-06-09 (M1-2)")

# Rh vs PAR
temporal_diurnal(SR_may22, Rh, "Rh", PPFD_IN_1_1_1, "PAR", "2022-05-22 ~ 2022-06-09 (M1-2)")

# Ra vs Ts
temporal_diurnal(SR_may22, Ra, "Ra", TS_1_1_1, "Ts5", "2022-05-22 ~ 2022-06-09 (M1-2)")

# Rh vs Ts
temporal_diurnal(SR_may22, Rh, "Rh", TS_1_1_1, "Ts5", "2022-05-22 ~ 2022-06-09 (M1-2)")

# Ra vs SWC
temporal_diurnal(SR_may22, Ra, "Ra", SWC_1_1_1, "SWC5", "2022-05-22 ~ 2022-06-09 (M1-2)")

# Rh vs SWC
temporal_diurnal(SR_may22, Rh, "Rh", SWC_1_1_1, "SWC5", "2022-05-22 ~ 2022-06-09 (M1-2)")



## feb24
# Ra vs PAR
temporal_diurnal(SR_feb24, Ra, "Ra", PPFD_1_1_1, "PAR", "2024-02-20 ~ 2024-03-09 (M5)")
```


```{r OLD corr matrix}
# corr for SR components with PAR, Ts, Ms

SR_may22 %>%
  select(c(SR, Rh, Ra, PPFD_IN_1_1_1, PPFD_IN_1_2_1, 
           TA_1_1_1, TS_1_1_1, TS_1_2_1, TS_2_1_1, TS_2_2_1, TS_2_3_1, SWC_1_1_1)) %>%
  chart.Correlation(histogram = TRUE, method = "pearson")
mtext("All day: 2022-05-22 ~ 2022-06-09 (M1-2)", side=3, line=3)

# only daytime
SR_may22 %>%
  filter(day_night == "day") %>%
  select(c(SR, Rh, Ra, PPFD_IN_1_1_1, PPFD_IN_1_2_1, 
           TA_1_1_1, TS_1_1_1, TS_1_2_1, TS_2_1_1, TS_2_2_1, TS_2_3_1, SWC_1_1_1)) %>%
  chart.Correlation(histogram = TRUE, method = "pearson")
mtext("Daytime: 2022-05-22 ~ 2022-06-09 (M1-2)", side=3, line=3)

# Ra analysis with time of the day color
ggplot(SR_may22 %>% filter(day_night == "day"), aes(PPFD_IN_1_1_1, Ra)) + 
  geom_point() +
  stat_poly_line()+
  stat_poly_eq(use_label(c("eq", "R2", "P"))) +
  theme_bw() + ggtitle("Daytime: 2022-05-22 ~ 2022-06-09 (M1-2)")

ggplot(SR_may22 %>% filter(day_night == "day"), aes(PPFD_IN_1_1_1, Rh)) + 
  geom_point() +
  stat_poly_line()+
  stat_poly_eq(use_label(c("eq", "R2", "P"))) +
  theme_bw() + ggtitle("Daytime: 2022-05-22 ~ 2022-06-09 (M1-2)")



# Ra vs PAR
# ref: https://stackoverflow.com/questions/74059684/how-can-i-plot-two-y-variables-with-big-difference-in-values-in-a-single-ggplot

# ggplot(data = SR_may22, aes(x = Datetime_30min_CST)) +
#   geom_line(aes (y = Ra, color = "Ra"),  size = 1.4, alpha = .5) +
#   geom_line(aes (y = PPFD_IN_1_1_1 / 380, color = "PAR"), size = 1.4, alpha = .5) +
#   scale_y_continuous(name = "Ra",
#                      sec.axis = sec_axis(trans = ~ . * 380, name = "PAR"))+
#   scale_color_manual("", values = c("#F8766D", "#00BFC4")) +
#   theme_bw() +
#   theme(legend.position = "top") + ggtitle("Ra (blue) vs PAR above (red)", subtitle = "Daytime: 2022-05-22 ~ 2022-06-09 (M1-2)")



# print out
#png("C:/Users/m0eka/Downloads/corr.png", res = 72, width = 1000, height = 1000, pointsize = 25)
# plot
#dev.off()

```

```{r overlapped diurnal pattern}
diurnal <- function(df, var1, var1_name, var2, var2_name, term){
    df %>%
    mutate(hour = as_hms(ymd_hms(Datetime_30min_CST)),
           var1_norm = rescale({{var1}}),
           var2_norm = rescale({{var2}})) %>% 
    filter(!is.na(hour)) %>%
    ggplot() + 
    geom_point(aes(hour, var1_norm, color = var1_name),alpha = .3) + 
    geom_smooth(aes(hour, var1_norm, color = var1_name),alpha = .3) + 
    geom_point(aes(hour, var2_norm, color = var2_name), alpha = .3) + 
    geom_smooth(aes(hour, var2_norm, color = var2_name),alpha = .3) +
    theme_bw() + scale_color_manual("", values = c("#F8766D", "#00BFC4")) +
    xlab("Time of day") + ylab("Normalized") + 
    ggtitle("Diurnal pattern", subtitle = term) +
    theme(axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 15),
          axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
          legend.title = element_text(size = 15), legend.text = element_text(size = 15),
          plot.title = element_text(size = 15, face = "bold"))
}

diurnal_3 <- function(df, var1, var1_name, var2, var2_name, var3, var3_name, term){
    df %>%
    mutate(hour = as_hms(ymd_hms(Datetime_30min_CST)),
           var1_norm = rescale({{var1}}),
           var2_norm = rescale({{var2}}),
           var3_norm = rescale({{var3}})) %>% 
    filter(!is.na(hour)) %>%
    ggplot() + 
    geom_point(aes(hour, var1_norm, color = var1_name),alpha = .3) + 
    geom_smooth(aes(hour, var1_norm, color = var1_name),alpha = .3) + 
    geom_point(aes(hour, var2_norm, color = var2_name), alpha = .3) + 
    geom_smooth(aes(hour, var2_norm, color = var2_name),alpha = .3) +
    geom_point(aes(hour, var3_norm, color = var3_name), alpha = .3) + 
    geom_smooth(aes(hour, var3_norm, color = var3_name),alpha = .3) +
    theme_bw() + scale_color_manual("", values = c("#F8766D", "#00BFC4", "#00BA38")) +
    xlab("Time of day") + ylab("Normalized") + 
    ggtitle("Diurnal pattern", subtitle = term) +
    theme(axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 15),
          axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
          legend.title = element_text(size = 15), legend.text = element_text(size = 15),
          plot.title = element_text(size = 15, face = "bold"))
}




## may22
# Ra vs PAR
diurnal(SR_may22, Ra, "Ra", PPFD_IN_1_1_1, "PAR", "2022-05-22 ~ 2022-06-09 (M1-2)")

# Rh vs PAR
diurnal(SR_may22, Rh, "Rh", PPFD_IN_1_1_1, "PAR", "2022-05-22 ~ 2022-06-09 (M1-2)")

# Ra vs Ts
diurnal_3(SR_may22, Ra, "Ra", TS_1_1_1, "Ts5", TS_1_2_1, "Ts20", "2022-05-22 ~ 2022-06-09 (M1-2)")

# Rh vs Ts
diurnal_3(SR_may22, Rh, "Rh", TS_1_1_1, "Ts5", TS_1_2_1, "Ts20", "2022-05-22 ~ 2022-06-09 (M1-2)")

# Ra vs SWC
diurnal(SR_may22, Ra, "Ra", SWC_1_1_1, "SWC5", "2022-05-22 ~ 2022-06-09 (M1-2)")

# Rh vs SWC
diurnal(SR_may22, Rh, "Rh", SWC_1_1_1, "SWC5", "2022-05-22 ~ 2022-06-09 (M1-2)")

# ratio
SR_may22 %>% 
  mutate(ratio = Rh/SR, hour =  as_hms(ymd_hms(Datetime_30min_CST))) %>% 
  ggplot(aes(hour, ratio)) + geom_point() + theme_bw() +
  ggtitle("Diurnal pattern in the Rh/SR", subtitle = "2022-05-22 ~ 2022-06-09 (M1-2)") +
  theme(axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 15),
          axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
          legend.title = element_text(size = 15), legend.text = element_text(size = 15),
          plot.title = element_text(size = 15, face = "bold"))


# ratio
SR_feb24 %>% 
  mutate(ratio = Rh/SR, hour =  as_hms(ymd_hms(Datetime_hr_CST))) %>% 
  ggplot(aes(hour, ratio)) + geom_point() + theme_bw() +
  ggtitle("Diurnal pattern in the Rh/SR", subtitle = "2024-02-20 ~ 2024-03-09 (M5)") +
  theme(axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 15),
          axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
          legend.title = element_text(size = 15), legend.text = element_text(size = 15),
          plot.title = element_text(size = 15, face = "bold"))
```


See the relationship between Ra and PAR with the +/- 12 hrs. Have to do leftjoin again as biomet dataset has wider data coverage. 

```{r delayed relationship - making df}


head(SR_may22) # starting from 2022-05-22 11:00:00
tail(SR_may22) # ending with 2022-06-09 15:00:00


SR_may22_lag <-
  left_join(data.frame(Datetime_30min_CST = seq(as.POSIXct("2022-05-22 23:00:00", tz = "America/Chicago"), 
                                            as_datetime("2022-06-09 21:00:00", tz = "America/Chicago"), by = "1 hour")),
          SR_may22 %>% select(c(Datetime_30min_CST, SR, Rh, Ra)), by = "Datetime_30min_CST") %>%
  left_join(biomet_22, by = c("Datetime_30min_CST" = "TIMESTAMP_START")) %>% 
  select(c(Datetime_30min_CST, SR, Rh, Ra, PPFD_IN_1_1_1, TS_1_1_1))

```



```{r plotting out regression lines for each lagged hours}


# function to make regression lines for each lagged hours
lag_plot_hour <- function(df, SR_var, col_start, col_end){
  plot_list <- list()
  colNames <- names(df)[col_start:col_end]
  
  for(i in colNames){
  plt <- 
    df %>% 
    ggplot(aes(y = .data[[SR_var]], x = .data[[i]])) +
    geom_point() + geom_smooth(method = "lm")  + 
    stat_cor(method="pearson") +
    stat_poly_eq(use_label(c("eq", "R2")), label.y = .9) +
    theme_bw() 
   
    plot_list[[i]] <- plt
  }
  plot_list
}

# print out
pdf("C:/Users/m0eka/Downloads/SR_may22_lag_Rh_PAR_plt_2.pdf", width=5, height=5)
lag_plot_hour(SR_may22_lag_PAR, "Rh", 5,29)
dev.off()

```


Pairwise correlation
- ref; https://stackoverflow.com/questions/13486000/pairwise-correlation-table
- ref: https://stackoverflow.com/questions/55940655/how-to-mutate-for-loop-in-dplyr

Want to make a function
```{r delayed relationship - delayed Ra & Rh}

head(SR_may22) # starting from 2022-05-22 11:00:00
tail(SR_may22) # ending with 2022-06-09 15:00:00



SR_may22_lag_Ra <- SR_may22_lag
  for(i in 1:12){
    
    new_col_name_pos <- paste0("Ra_lag_pos", as.character(i))
    new_col_name_neg <- paste0("Ra_lag_neg", as.character(i))
    
    SR_may22_lag_Ra <- SR_may22_lag_Ra %>% 
        mutate(!!sym(new_col_name_pos) := Lag(Ra, i),
               !!sym(new_col_name_neg) := Lag(Ra, -1*i))
  }

pairwiseCor_Ra <- function(dataframe){
    list_0_12 <- 0
    for (i in 1:12) {
         list_0_12 <- c(list_0_12, i, -i)
     }
  
    df <- data.frame(Var1 = c(rep("SR", 25), rep("Rh", 25), rep("PPFD_IN_1_1_1", 25), rep("TS_1_1_1", 25)), 
                   Var2 = rep(names(dataframe[,c(4,7:30)]), 4),
                   lag = rep(list_0_12, 4),
                   Cor = rep(0,100))
    
    for (i in 1:nrow(df)) {
      df[i, 4] <- round(x = cor(dataframe[,df[[1]][i]], 
                              y = dataframe[,df[[2]][i]], 
                              use = "complete.obs"), 4)
      }
  df
  }

SR_may22_lag_Ra_res <- pairwiseCor_Ra(SR_may22_lag_Ra)


# result corr plot function
lag_corr_res <- 
  function(df, term, var_name){
    ggplot(df, aes(lag, Cor, col = Var1)) + 
    geom_line() + 
    geom_point() + 
    theme_bw() +
    geom_hline(yintercept = 0, color="black", size=1.5, alpha=0.2) +
    ggtitle(paste0("Pearson correlation of lagged ", var_name), 
            subtitle = term) + 
    xlab("Lag (hour)") + ylab("Correlation coefficient") + 
    theme(axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 15),
            axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
            legend.title = element_text(size = 15), legend.text = element_text(size = 15),
            plot.title = element_text(size = 15, face = "bold"))
    }

# result corr plot
lag_corr_res(SR_may22_lag_Ra_res, "2022-05-22 ~ 2022-06-09 (M1-2)", "Ra")

# find the max corr
SR_may22_lag_Ra_res %>%
  group_by(Var1) %>%
  slice(which.max(Cor))

# plot results
# Ra vs PAR
diurnal_3(SR_may22_lag_Ra, PPFD_IN_1_1_1, "PAR", Ra, "Ra", Ra_lag_pos9, "Ra+9", "2022-05-22 ~ 2022-06-09 (M1-2)")


#############
#### Rh ####
SR_may22_lag_Rh <- SR_may22_lag
  for(i in 1:12){
    
    new_col_name_pos <- paste0("Rh_lag_pos", as.character(i))
    new_col_name_neg <- paste0("Rh_lag_neg", as.character(i))
    
    SR_may22_lag_Rh <- SR_may22_lag_Rh %>% 
        mutate(!!sym(new_col_name_pos) := Lag(Rh, i),
               !!sym(new_col_name_neg) := Lag(Rh, -1*i))
  }

pairwiseCor_Rh <- function(dataframe){
    list_0_12 <- 0
    for (i in 1:12) {
         list_0_12 <- c(list_0_12, i, -i)
     }
  
    df <- data.frame(Var1 = c(rep("SR", 25), rep("Ra", 25), rep("PPFD_IN_1_1_1", 25), rep("TS_1_1_1", 25)), 
                   Var2 = rep(names(dataframe[,c(3,7:30)]), 4),
                   lag = rep(list_0_12, 4),
                   Cor = rep(0,100))
    
    for (i in 1:nrow(df)) {
      df[i, 4] <- round(x = cor(dataframe[,df[[1]][i]], 
                              y = dataframe[,df[[2]][i]], 
                              use = "complete.obs"), 4)
      }
  df
}

SR_may22_lag_Rh_res <- pairwiseCor_Rh(SR_may22_lag_Rh)

# result corr plot
lag_corr_res(SR_may22_lag_Rh_res, "2022-05-22 ~ 2022-06-09 (M1-2)", "Rh")

# find the max corr
SR_may22_lag_Rh_res %>%
  group_by(Var1) %>%
  slice(which.max(Cor))


# plot results
# Rh vs PAR
diurnal_3(SR_may22_lag_Rh, PPFD_IN_1_1_1, "PAR", Rh, "Rh", Rh_lag_neg4, "Rh-4", "2022-05-22 ~ 2022-06-09 (M1-2)")

# Rh vs Ts
diurnal_3(SR_may22_lag_Rh, TS_1_1_1, "Ts5", Rh, "Rh", Rh_lag_neg1, "Rh-1", "2022-05-22 ~ 2022-06-09 (M1-2)")


```



```{r SR_nov_22 corr}
# for SR_nov_22

head(SR_nov22) # starting from 2022-11-23 13:30:00
tail(SR_nov22) # ending with 2022-11-30 16:30:00

SR_nov22_lag <-
  left_join(data.frame(Datetime_30min_CST = seq(as.POSIXct("2022-11-22 01:30:00", tz = "America/Chicago"), 
                                            as_datetime("2022-12-01 04:30:00", tz = "America/Chicago"), by = "1 hour")),
          SR_nov22 %>% select(c(Datetime_30min_CST, SR, Rh, Ra)), by = "Datetime_30min_CST") %>%
  left_join(biomet_22, by = c("Datetime_30min_CST" = "TIMESTAMP_START")) %>% 
  select(c(Datetime_30min_CST, SR, Rh, Ra, PPFD_IN_1_1_1, TS_1_1_1))


SR_nov22_lag_Ra <- SR_nov22_lag
  for(i in 1:12){
    
    new_col_name_pos <- paste0("Ra_lag_pos", as.character(i))
    new_col_name_neg <- paste0("Ra_lag_neg", as.character(i))
    
    SR_nov22_lag_Ra <- SR_nov22_lag_Ra %>% 
        mutate(!!sym(new_col_name_pos) := Lag(Ra, i),
               !!sym(new_col_name_neg) := Lag(Ra, -1*i))
  }


SR_nov22_lag_Ra_res <- pairwiseCor_Ra(SR_nov22_lag_Ra)

# result
ggplot(SR_nov22_lag_Ra_res, aes(lag, Cor, col = Var1)) + 
  geom_line() + 
  geom_point() + 
  theme_bw() +
  geom_hline(yintercept = 0, color="black", size=1.5, alpha=0.2) +
  ggtitle("Pearson correlation of lagged Rh", 
          subtitle = "All day: 2022-05-22 ~ 2022-06-09 (M1-2)") + 
  xlab("Lag (hour)") + ylab("Correlation coefficient") +
  theme(axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 15),
          axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
          legend.title = element_text(size = 15), legend.text = element_text(size = 15),
          plot.title = element_text(size = 15, face = "bold"))

# result corr plot
lag_corr_res(SR_nov22_lag_Ra_res, "2022-11-23 ~ 2022-12-01 (M7)", "Ra")


# find the max corr
SR_nov22_lag_Ra_res %>%
  group_by(Var1) %>%
  slice(which.max(Cor))

# plot results
# Ra vs PAR
diurnal_3(SR_nov22_lag_Ra, PPFD_IN_1_1_1, "PAR", Ra, "Ra", Ra_lag_neg8, "Ra-8", "2022-11-23 ~ 2022-12-01 (M7)")

#######
# Rh ##
SR_nov22_lag_Rh <- SR_nov22_lag
  for(i in 1:12){
    
    new_col_name_pos <- paste0("Rh_lag_pos", as.character(i))
    new_col_name_neg <- paste0("Rh_lag_neg", as.character(i))
    
    SR_nov22_lag_Rh <- SR_nov22_lag_Rh %>% 
        mutate(!!sym(new_col_name_pos) := Lag(Rh, i),
               !!sym(new_col_name_neg) := Lag(Rh, -1*i))
  }


SR_nov22_lag_Rh_res <- pairwiseCor_Rh(SR_nov22_lag_Rh)

# result corr plot
lag_corr_res(SR_nov22_lag_Rh_res, "2022-11-23 ~ 2022-12-01 (M7)", "Rh")

# find the max corr
SR_nov22_lag_Rh_res %>%
  group_by(Var1) %>%
  slice(which.max(Cor))

# plot results
# Rh vs PAR
diurnal_3(SR_nov22_lag_Rh, PPFD_IN_1_1_1, "PAR", Rh, "Rh", Rh_lag_neg4, "Rh-4", "2022-11-23 ~ 2022-12-01 (M7)")

# Rh vs Ts
diurnal(SR_nov22_lag_Rh, TS_1_1_1, "Ts5", Rh, "Rh", "2022-11-23 ~ 2022-12-01 (M7)")
```

```{r SR_mar23 corr}
# for SR_mar23 

head(SR_mar23) # starting from 2023-03-15 20:30:00
tail(SR_mar23) # ending with 2023-04-01 14:30:00

SR_mar23_lag <-
  left_join(data.frame(Datetime_30min_CST = seq(as.POSIXct("2023-03-15 08:30:00", tz = "America/Chicago"), 
                                            as.POSIXct("2023-04-02 02:30:00", tz = "America/Chicago"), by = "1 hour")),
          SR_mar23 %>% select(c(Datetime_30min_CST, SR, Rh, Ra)), by = "Datetime_30min_CST") %>%
  left_join(biomet_23, by = c("Datetime_30min_CST" = "TIMESTAMP_START")) %>% 
  select(c(Datetime_30min_CST, SR, Rh, Ra, PPFD_IN_1_1_1, TS_1_1_1))


SR_mar23_lag_Ra <- SR_mar23_lag
  for(i in 1:12){
    
    new_col_name_pos <- paste0("Ra_lag_pos", as.character(i))
    new_col_name_neg <- paste0("Ra_lag_neg", as.character(i))
    
    SR_mar23_lag_Ra <- SR_mar23_lag_Ra %>% 
        mutate(!!sym(new_col_name_pos) := Lag(Ra, i),
               !!sym(new_col_name_neg) := Lag(Ra, -1*i))
  }


SR_mar23_lag_Ra_res <- pairwiseCor_Ra(SR_mar23_lag_Ra)


# result corr plot
lag_corr_res(SR_mar23_lag_Ra_res, "2023-03-15 ~ 2023-04-01 (M10-11)", "Ra")

# find the max corr
SR_mar23_lag_Ra_res %>%
  group_by(Var1) %>%
  slice(which.max(Cor))

# plot results
# Ra vs PAR
diurnal_3(SR_mar23_lag_Ra, PPFD_IN_1_1_1, "PAR", Ra, "Ra", Ra_lag_pos12, "Ra+12", "2023-03-15 ~ 2023-04-01 (M10-11)")

#######
# Rh ##
SR_mar23_lag_Rh <- SR_mar23_lag
  for(i in 1:12){
    
    new_col_name_pos <- paste0("Rh_lag_pos", as.character(i))
    new_col_name_neg <- paste0("Rh_lag_neg", as.character(i))
    
    SR_mar23_lag_Rh <- SR_mar23_lag_Rh %>% 
        mutate(!!sym(new_col_name_pos) := Lag(Rh, i),
               !!sym(new_col_name_neg) := Lag(Rh, -1*i))
  }


SR_mar23_lag_Rh_res <- pairwiseCor_Rh(SR_mar23_lag_Rh)

# result corr plot
lag_corr_res(SR_mar23_lag_Rh_res, "2023-03-15 ~ 2023-04-01 (M10-11)", "Ra")

# find the max corr
SR_mar23_lag_Rh_res %>%
  group_by(Var1) %>%
  slice(which.max(Cor))

# plot results
# Rh vs PAR
diurnal_3(SR_mar23_lag_Rh, PPFD_IN_1_1_1, "PAR", Rh, "Rh", Rh_lag_neg3, "Rh-3", "2023-03-15 ~ 2023-04-01 (M10-11)")

# Rh vs Ts
diurnal_3(SR_mar23_lag_Rh, TS_1_1_1, "Ts5", Rh, "Rh", Rh_lag_neg2, "Rh-2", "2023-03-15 ~ 2023-04-01 (M10-11)")

```

"From 2023-04-30 to 2023-06-08"
```{r may23}
# for SR_may23 

head(SR_may23_2) # starting from 2023-05-23 17:30:00
tail(SR_may23_2) # ending with 2023-06-07 11:30:00

SR_may23_2_lag <-
  left_join(data.frame(Datetime_30min_CST = seq(as_datetime("2023-05-23 05:30:00", tz = "America/Chicago"),
                                                as.POSIXct("2023-06-07 23:30:00", tz = "America/Chicago"), by = "1 hour")),
          SR_may23_2 %>% select(c(Datetime_30min_CST, SR, Rh, Ra)), by = "Datetime_30min_CST") %>%
  left_join(biomet_23, by = c("Datetime_30min_CST" = "TIMESTAMP_START")) %>% 
  select(c(Datetime_30min_CST, SR, Rh, Ra, PPFD_IN_1_1_1, TS_1_1_1))


SR_may23_2_lag_Ra <- SR_may23_2_lag
  for(i in 1:12){
    
    new_col_name_pos <- paste0("Ra_lag_pos", as.character(i))
    new_col_name_neg <- paste0("Ra_lag_neg", as.character(i))
    
    SR_may23_2_lag_Ra <- SR_may23_2_lag_Ra %>% 
        mutate(!!sym(new_col_name_pos) := Lag(Ra, i),
               !!sym(new_col_name_neg) := Lag(Ra, -1*i))
  }


SR_may23_2_lag_Ra_res <- pairwiseCor_Ra(SR_may23_2_lag_Ra)

# result corr plot
lag_corr_res(SR_may23_2_lag_Ra_res, "2023-05-23 ~ 2023-06-07 (M1)", "Ra")

# find the max corr
SR_may23_2_lag_Ra_res %>%
  group_by(Var1) %>%
  slice(which.max(Cor))

# plot results
# Ra vs PAR
diurnal_3(SR_may23_2_lag_Ra, PPFD_IN_1_1_1, "PAR", Ra, "Ra", Ra_lag_neg2, "Ra-2", "2023-05-23 ~ 2023-06-07 (M1)")


# Rh
SR_may23_2_lag_Rh <- SR_may23_2_lag
  for(i in 1:12){
    
    new_col_name_pos <- paste0("Rh_lag_pos", as.character(i))
    new_col_name_neg <- paste0("Rh_lag_neg", as.character(i))
    
    SR_may23_2_lag_Rh <- SR_may23_2_lag_Rh %>% 
        mutate(!!sym(new_col_name_pos) := Lag(Rh, i),
               !!sym(new_col_name_neg) := Lag(Rh, -1*i))
  }


SR_may23_2_lag_Rh_res <- pairwiseCor_Rh(SR_may23_2_lag_Rh)

# result corr plot
lag_corr_res(SR_may23_2_lag_Rh_res, "2023-05-23 ~ 2023-06-07 (M1)", "Rh")

# find the max corr
SR_may23_2_lag_Rh_res %>%
  group_by(Var1) %>%
  slice(which.max(Cor))

# plot results
# Rh vs PAR
diurnal(SR_may23_2_lag_Rh, PPFD_IN_1_1_1, "PAR", Rh, "Rh", "2023-05-23 ~ 2023-06-07 (M1)")

# Rh vs Ts
diurnal_3(SR_may23_2_lag_Rh, TS_1_1_1, "Ts5", Rh, "Rh", Rh_lag_neg2, "Rh-2", "2023-05-23 ~ 2023-06-07 (M1)")
```












```{r corr between conductance vs other variables}
# test from SR_may22

SR_may22_cond <- 
  left_join(SR_may22, cond_22 %>% select(c(TIMESTAMP_START, gs), by = "TIMESTAMP_START"))

# plot
ggplot(data = SR_may22_cond, aes(x = Datetime_30min_CST)) +
  geom_line(aes (y = rescale(Ra), color = "Ra"),  size = 1.4, alpha = .5) +
  geom_line(aes (y = rescale(gs), color = "conductance"), size = 1.4, alpha = .5) +
  scale_color_manual("", values = c("#F8766D", "#00BFC4")) +
  theme_bw() +
  theme(legend.position = "top") + ggtitle("Ra (blue) vs canopy conductance (red)", subtitle = "Daytime: 2022-05-22 ~ 2022-06-09 (M1-2)") +
  theme(axis.title.x = element_text(size = 15), axis.text.x = element_text(size = 15),
        axis.title.y = element_text(size = 15), axis.text.y = element_text(size = 15),
        legend.title = element_text(size = 15), legend.text = element_text(size = 15),
        plot.title = element_text(size = 15, face = "bold"))

```















```{r Quality control related to flux, eval = FALSE, echo = FALSE}


qaqc_raw <- 
  read_sheet("https://docs.google.com/spreadsheets/d/1kTouf8vyP3Rr_LUJ9WIog5rC-5Uj50zLCECRWohrht4/edit#gid=0",
             col_types = "cTncnnninnncnnnnnc")

# Remove the data which didn't meet the instrument criteria
qaqc <- qaqc_raw[sum1$`Obs#`,]

# Use the better estimation data with higher R2 
qaqc$Flux <- NA
for(i in 1:nrow(qaqc)){
  if(qaqc$Exp_R2[i] >= qaqc$Lin_R2[i]){qaqc$Flux[i] <- qaqc$Exp_Flux[i]}
  else{qaqc$Flux[i] <- qaqc$Lin_Flux[i]}
}

# The final paired graph
pairs(qaqc[,c(5:7,9:11,13:17)],
      lower.panel = NULL, 
      col = factor(qaqc$Label),
      cex.labels=3)

# Plot out the flux
ggplot(qaqc,aes(Date_IV, Flux, col=Label))+geom_point()+
  #ylab("Fraction")+#ggtitle("Temporal changes in fraction")+
  theme(axis.title.x = element_blank(),axis.text.x = element_text(size = 20),
        axis.title.y = element_text(size = 30),axis.text.y = element_text(size = 30),
        legend.title = element_text(size = 25),legend.text = element_text(size = 25))

```

```{r output the final data to a spreadsheet, eval = FALSE, echo = FALSE}

#write.csv(qaqc, "G:/My Drive/research/DC_auto/DC_auto_after_qaqc.csv", row.names = FALSE)

# NEED SOME WAYS TO APPEND DATA TO THE EXISTING FILE
```
